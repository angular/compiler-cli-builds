{"version":3,"file":"bundle_index_host.js","sourceRoot":"","sources":["../../../../../packages/compiler-cli/src/metadata/bundle_index_host.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport * as ts from 'typescript';\n\nimport {CompilerOptions} from '../transformers/api';\nimport {MetadataCache} from '../transformers/metadata_cache';\n\nimport {CompilerHostAdapter, MetadataBundler} from './bundler';\nimport {privateEntriesToIndex} from './index_writer';\n\nconst DTS = /\\.d\\.ts$/;\nconst JS_EXT = /(\\.js|)$/;\n\nfunction createSyntheticIndexHost<H extends ts.CompilerHost>(\n    delegate: H, syntheticIndex: {name: string, content: string, getMetadata: () => string}): H {\n  const normalSyntheticIndexName = path.normalize(syntheticIndex.name);\n\n  const newHost = Object.create(delegate);\n  newHost.fileExists = (fileName: string): boolean => {\n    return path.normalize(fileName) == normalSyntheticIndexName || delegate.fileExists(fileName);\n  };\n\n  newHost.readFile = (fileName: string) => {\n    return path.normalize(fileName) == normalSyntheticIndexName ? syntheticIndex.content :\n                                                                  delegate.readFile(fileName);\n  };\n\n  newHost.getSourceFile =\n      (fileName: string, languageVersion: ts.ScriptTarget, onError?: (message: string) => void) => {\n        if (path.normalize(fileName) == normalSyntheticIndexName) {\n          const sf = ts.createSourceFile(fileName, syntheticIndex.content, languageVersion, true);\n          if ((delegate as any).fileNameToModuleName) {\n            sf.moduleName = (delegate as any).fileNameToModuleName(fileName);\n          }\n          return sf;\n        }\n        return delegate.getSourceFile(fileName, languageVersion, onError);\n      };\n\n  newHost.writeFile =\n      (fileName: string, data: string, writeByteOrderMark: boolean,\n       onError: ((message: string) => void) | undefined,\n       sourceFiles: Readonly<ts.SourceFile>[]) => {\n        delegate.writeFile(fileName, data, writeByteOrderMark, onError, sourceFiles);\n        if (fileName.match(DTS) && sourceFiles && sourceFiles.length == 1 &&\n            path.normalize(sourceFiles[0].fileName) === normalSyntheticIndexName) {\n          // If we are writing the synthetic index, write the metadata along side.\n          const metadataName = fileName.replace(DTS, '.metadata.json');\n          const indexMetadata = syntheticIndex.getMetadata();\n          delegate.writeFile(metadataName, indexMetadata, writeByteOrderMark, onError, []);\n        }\n      };\n  return newHost;\n}\n\nexport function createBundleIndexHost<H extends ts.CompilerHost>(\n    ngOptions: CompilerOptions, rootFiles: ReadonlyArray<string>, host: H,\n    getMetadataCache: () =>\n        MetadataCache): {host: H, indexName?: string, errors?: ts.Diagnostic[]} {\n  const files = rootFiles.filter(f => !DTS.test(f));\n  let indexFile: string|undefined;\n  if (files.length === 1) {\n    indexFile = files[0];\n  } else {\n    for (const f of files) {\n      // Assume the shortest file path called index.ts is the entry point\n      if (f.endsWith(path.sep + 'index.ts')) {\n        if (!indexFile || indexFile.length > f.length) {\n          indexFile = f;\n        }\n      }\n    }\n  }\n  if (!indexFile) {\n    return {\n      host,\n      errors: [{\n        file: null as any as ts.SourceFile,\n        start: null as any as number,\n        length: null as any as number,\n        messageText:\n            'Angular compiler option \"flatModuleIndex\" requires one and only one .ts file in the \"files\" field.',\n        category: ts.DiagnosticCategory.Error,\n        code: 0\n      }]\n    };\n  }\n\n  const indexModule = indexFile.replace(/\\.ts$/, '');\n\n  // The operation of producing a metadata bundle happens twice - once during setup and once during\n  // the emit phase. The first time, the bundle is produced without a metadata cache, to compute the\n  // contents of the flat module index. The bundle produced during emit does use the metadata cache\n  // with associated transforms, so the metadata will have lowered expressions, resource inlining,\n  // etc.\n  const getMetadataBundle = (cache: MetadataCache | null) => {\n    const bundler = new MetadataBundler(\n        indexModule, ngOptions.flatModuleId, new CompilerHostAdapter(host, cache),\n        ngOptions.flatModulePrivateSymbolPrefix);\n    return bundler.getMetadataBundle();\n  };\n\n  // First, produce the bundle with no MetadataCache.\n  const metadataBundle = getMetadataBundle(/* MetadataCache */ null);\n  const name =\n      path.join(path.dirname(indexModule), ngOptions.flatModuleOutFile !.replace(JS_EXT, '.ts'));\n  const libraryIndex = `./${path.basename(indexModule)}`;\n  const content = privateEntriesToIndex(libraryIndex, metadataBundle.privates);\n\n  host = createSyntheticIndexHost(host, {\n    name,\n    content,\n    getMetadata: () => {\n      // The second metadata bundle production happens on-demand, and uses the getMetadataCache\n      // closure to retrieve an up-to-date MetadataCache which is configured with whatever metadata\n      // transforms were used to produce the JS output.\n      const metadataBundle = getMetadataBundle(getMetadataCache());\n      return JSON.stringify(metadataBundle.metadata);\n    }\n  });\n  return {host, indexName: name};\n}\n"]}