/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import * as ts from 'typescript';
/**
 * Different optimizers use different annotations on a function or method call to indicate its pure
 * status.
 */
var PureAnnotation;
(function (PureAnnotation) {
    /**
     * Closure's annotation for purity is `@pureOrBreakMyCode`, but this needs to be in a semantic
     * (jsdoc) enabled comment. Thus, the actual comment text for Closure must include the `*` that
     * turns a `/*` comment into a `/**` comment, as well as surrounding whitespace.
     */
    PureAnnotation["CLOSURE"] = "* @pureOrBreakMyCode ";
    PureAnnotation["TERSER"] = "@__PURE__";
})(PureAnnotation || (PureAnnotation = {}));
const UNARY_OPERATORS = {
    '+': ts.SyntaxKind.PlusToken,
    '-': ts.SyntaxKind.MinusToken,
    '!': ts.SyntaxKind.ExclamationToken,
};
const BINARY_OPERATORS = {
    '&&': ts.SyntaxKind.AmpersandAmpersandToken,
    '>': ts.SyntaxKind.GreaterThanToken,
    '>=': ts.SyntaxKind.GreaterThanEqualsToken,
    '&': ts.SyntaxKind.AmpersandToken,
    '/': ts.SyntaxKind.SlashToken,
    '==': ts.SyntaxKind.EqualsEqualsToken,
    '===': ts.SyntaxKind.EqualsEqualsEqualsToken,
    '<': ts.SyntaxKind.LessThanToken,
    '<=': ts.SyntaxKind.LessThanEqualsToken,
    '-': ts.SyntaxKind.MinusToken,
    '%': ts.SyntaxKind.PercentToken,
    '*': ts.SyntaxKind.AsteriskToken,
    '!=': ts.SyntaxKind.ExclamationEqualsToken,
    '!==': ts.SyntaxKind.ExclamationEqualsEqualsToken,
    '||': ts.SyntaxKind.BarBarToken,
    '+': ts.SyntaxKind.PlusToken,
    '??': ts.SyntaxKind.QuestionQuestionToken,
};
const VAR_TYPES = {
    'const': ts.NodeFlags.Const,
    'let': ts.NodeFlags.Let,
    'var': ts.NodeFlags.None,
};
/**
 * A TypeScript flavoured implementation of the AstFactory.
 */
export class TypeScriptAstFactory {
    constructor(annotateForClosureCompiler) {
        this.annotateForClosureCompiler = annotateForClosureCompiler;
        this.externalSourceFiles = new Map();
        this.attachComments = attachComments;
        this.createArrayLiteral = ts.createArrayLiteral;
        this.createConditional = ts.createConditional;
        this.createElementAccess = ts.createElementAccess;
        this.createExpressionStatement = ts.createExpressionStatement;
        this.createIdentifier = ts.createIdentifier;
        this.createParenthesizedExpression = ts.createParen;
        this.createPropertyAccess = ts.createPropertyAccess;
        this.createThrowStatement = ts.createThrow;
        this.createTypeOfExpression = ts.createTypeOf;
    }
    createAssignment(target, value) {
        return ts.createBinary(target, ts.SyntaxKind.EqualsToken, value);
    }
    createBinaryExpression(leftOperand, operator, rightOperand) {
        return ts.createBinary(leftOperand, BINARY_OPERATORS[operator], rightOperand);
    }
    createBlock(body) {
        return ts.createBlock(body);
    }
    createCallExpression(callee, args, pure) {
        const call = ts.createCall(callee, undefined, args);
        if (pure) {
            ts.addSyntheticLeadingComment(call, ts.SyntaxKind.MultiLineCommentTrivia, this.annotateForClosureCompiler ? PureAnnotation.CLOSURE : PureAnnotation.TERSER, 
            /* trailing newline */ false);
        }
        return call;
    }
    createFunctionDeclaration(functionName, parameters, body) {
        if (!ts.isBlock(body)) {
            throw new Error(`Invalid syntax, expected a block, but got ${ts.SyntaxKind[body.kind]}.`);
        }
        return ts.createFunctionDeclaration(undefined, undefined, undefined, functionName, undefined, parameters.map(param => ts.createParameter(undefined, undefined, undefined, param)), undefined, body);
    }
    createFunctionExpression(functionName, parameters, body) {
        if (!ts.isBlock(body)) {
            throw new Error(`Invalid syntax, expected a block, but got ${ts.SyntaxKind[body.kind]}.`);
        }
        return ts.createFunctionExpression(undefined, undefined, functionName !== null && functionName !== void 0 ? functionName : undefined, undefined, parameters.map(param => ts.createParameter(undefined, undefined, undefined, param)), undefined, body);
    }
    createIfStatement(condition, thenStatement, elseStatement) {
        return ts.createIf(condition, thenStatement, elseStatement !== null && elseStatement !== void 0 ? elseStatement : undefined);
    }
    createLiteral(value) {
        if (value === undefined) {
            return ts.createIdentifier('undefined');
        }
        else if (value === null) {
            return ts.createNull();
        }
        else {
            return ts.createLiteral(value);
        }
    }
    createNewExpression(expression, args) {
        return ts.createNew(expression, undefined, args);
    }
    createObjectLiteral(properties) {
        return ts.createObjectLiteral(properties.map(prop => ts.createPropertyAssignment(prop.quoted ? ts.createLiteral(prop.propertyName) :
            ts.createIdentifier(prop.propertyName), prop.value)));
    }
    createReturnStatement(expression) {
        return ts.createReturn(expression !== null && expression !== void 0 ? expression : undefined);
    }
    createTaggedTemplate(tag, template) {
        let templateLiteral;
        const length = template.elements.length;
        const head = template.elements[0];
        if (length === 1) {
            templateLiteral = ts.createNoSubstitutionTemplateLiteral(head.cooked, head.raw);
        }
        else {
            const spans = [];
            // Create the middle parts
            for (let i = 1; i < length - 1; i++) {
                const { cooked, raw, range } = template.elements[i];
                const middle = createTemplateMiddle(cooked, raw);
                if (range !== null) {
                    this.setSourceMapRange(middle, range);
                }
                spans.push(ts.createTemplateSpan(template.expressions[i - 1], middle));
            }
            // Create the tail part
            const resolvedExpression = template.expressions[length - 2];
            const templatePart = template.elements[length - 1];
            const templateTail = createTemplateTail(templatePart.cooked, templatePart.raw);
            if (templatePart.range !== null) {
                this.setSourceMapRange(templateTail, templatePart.range);
            }
            spans.push(ts.createTemplateSpan(resolvedExpression, templateTail));
            // Put it all together
            templateLiteral =
                ts.createTemplateExpression(ts.createTemplateHead(head.cooked, head.raw), spans);
        }
        if (head.range !== null) {
            this.setSourceMapRange(templateLiteral, head.range);
        }
        return ts.createTaggedTemplate(tag, templateLiteral);
    }
    createUnaryExpression(operator, operand) {
        return ts.createPrefix(UNARY_OPERATORS[operator], operand);
    }
    createVariableDeclaration(variableName, initializer, type) {
        return ts.createVariableStatement(undefined, ts.createVariableDeclarationList([ts.createVariableDeclaration(variableName, undefined, initializer !== null && initializer !== void 0 ? initializer : undefined)], VAR_TYPES[type]));
    }
    setSourceMapRange(node, sourceMapRange) {
        if (sourceMapRange === null) {
            return node;
        }
        const url = sourceMapRange.url;
        if (!this.externalSourceFiles.has(url)) {
            this.externalSourceFiles.set(url, ts.createSourceMapSource(url, sourceMapRange.content, pos => pos));
        }
        const source = this.externalSourceFiles.get(url);
        ts.setSourceMapRange(node, { pos: sourceMapRange.start.offset, end: sourceMapRange.end.offset, source });
        return node;
    }
}
// HACK: Use this in place of `ts.createTemplateMiddle()`.
// Revert once https://github.com/microsoft/TypeScript/issues/35374 is fixed.
export function createTemplateMiddle(cooked, raw) {
    const node = ts.createTemplateHead(cooked, raw);
    node.kind = ts.SyntaxKind.TemplateMiddle;
    return node;
}
// HACK: Use this in place of `ts.createTemplateTail()`.
// Revert once https://github.com/microsoft/TypeScript/issues/35374 is fixed.
export function createTemplateTail(cooked, raw) {
    const node = ts.createTemplateHead(cooked, raw);
    node.kind = ts.SyntaxKind.TemplateTail;
    return node;
}
/**
 * Attach the given `leadingComments` to the `statement` node.
 *
 * @param statement The statement that will have comments attached.
 * @param leadingComments The comments to attach to the statement.
 */
export function attachComments(statement, leadingComments) {
    for (const comment of leadingComments) {
        const commentKind = comment.multiline ? ts.SyntaxKind.MultiLineCommentTrivia :
            ts.SyntaxKind.SingleLineCommentTrivia;
        if (comment.multiline) {
            ts.addSyntheticLeadingComment(statement, commentKind, comment.toString(), comment.trailingNewline);
        }
        else {
            for (const line of comment.toString().split('\n')) {
                ts.addSyntheticLeadingComment(statement, commentKind, line, comment.trailingNewline);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZXNjcmlwdF9hc3RfZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvbXBpbGVyLWNsaS9zcmMvbmd0c2MvdHJhbnNsYXRvci9zcmMvdHlwZXNjcmlwdF9hc3RfZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0dBTUc7QUFDSCxPQUFPLEtBQUssRUFBRSxNQUFNLFlBQVksQ0FBQztBQUlqQzs7O0dBR0c7QUFDSCxJQUFLLGNBU0o7QUFURCxXQUFLLGNBQWM7SUFDakI7Ozs7T0FJRztJQUNILG1EQUFpQyxDQUFBO0lBRWpDLHNDQUFvQixDQUFBO0FBQ3RCLENBQUMsRUFUSSxjQUFjLEtBQWQsY0FBYyxRQVNsQjtBQUVELE1BQU0sZUFBZSxHQUFrRDtJQUNyRSxHQUFHLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTO0lBQzVCLEdBQUcsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLFVBQVU7SUFDN0IsR0FBRyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsZ0JBQWdCO0NBQ3BDLENBQUM7QUFFRixNQUFNLGdCQUFnQixHQUE4QztJQUNsRSxJQUFJLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyx1QkFBdUI7SUFDM0MsR0FBRyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsZ0JBQWdCO0lBQ25DLElBQUksRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLHNCQUFzQjtJQUMxQyxHQUFHLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxjQUFjO0lBQ2pDLEdBQUcsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLFVBQVU7SUFDN0IsSUFBSSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsaUJBQWlCO0lBQ3JDLEtBQUssRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLHVCQUF1QjtJQUM1QyxHQUFHLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxhQUFhO0lB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QUUsR0FBVztJQUM1RCxNQUFNLElBQUksR0FBK0IsRUFBRSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMzRSxJQUFJLENBQUMsSUFBc0IsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQztJQUMxRCxPQUFPLElBQXVCLENBQUM7QUFDakMsQ0FBQztBQUVEOzs7OztHQUtHO0FBQ0gsTUFBTSxVQUFVLGNBQWMsQ0FBQyxTQUF1QixFQUFFLGVBQWlDO0lBQ3ZGLEtBQUssTUFBTSxPQUFPLElBQUksZUFBZSxFQUFFO1FBQ3JDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsc0JBQXNCLENBQUMsQ0FBQztZQUN0QyxFQUFFLENBQUMsVUFBVSxDQUFDLHVCQUF1QixDQUFDO1FBQzlFLElBQUksT0FBTyxDQUFDLFNBQVMsRUFBRTtZQUNyQixFQUFFLENBQUMsMEJBQTBCLENBQ3pCLFNBQVMsRUFBRSxXQUFXLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztTQUMxRTthQUFNO1lBQ0wsS0FBSyxNQUFNLElBQUksSUFBSSxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNqRCxFQUFFLENBQUMsMEJBQTBCLENBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO2FBQ3RGO1NBQ0Y7S0FDRjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIExMQyBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGFuIE1JVC1zdHlsZSBsaWNlbnNlIHRoYXQgY2FuIGJlXG4gKiBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGF0IGh0dHBzOi8vYW5ndWxhci5pby9saWNlbnNlXG4gKi9cbmltcG9ydCAqIGFzIHRzIGZyb20gJ3R5cGVzY3JpcHQnO1xuXG5pbXBvcnQge0FzdEZhY3RvcnksIEJpbmFyeU9wZXJhdG9yLCBMZWFkaW5nQ29tbWVudCwgT2JqZWN0TGl0ZXJhbFByb3BlcnR5LCBTb3VyY2VNYXBSYW5nZSwgVGVtcGxhdGVMaXRlcmFsLCBVbmFyeU9wZXJhdG9yLCBWYXJpYWJsZURlY2xhcmF0aW9uVHlwZX0gZnJvbSAnLi9hcGkvYXN0X2ZhY3RvcnknO1xuXG4vKipcbiAqIERpZmZlcmVudCBvcHRpbWl6ZXJzIHVzZSBkaWZmZXJlbnQgYW5ub3RhdGlvbnMgb24gYSBmdW5jdGlvbiBvciBtZXRob2QgY2FsbCB0byBpbmRpY2F0ZSBpdHMgcHVyZVxuICogc3RhdHVzLlxuICovXG5lbnVtIFB1cmVBbm5vdGF0aW9uIHtcbiAgLyoqXG4gICAqIENsb3N1cmUncyBhbm5vdGF0aW9uIGZvciBwdXJpdHkgaXMgYEBwdXJlT3JCcmVha015Q29kZWAsIGJ1dCB0aGlzIG5lZWRzIHRvIGJlIGluIGEgc2VtYW50aWNcbiAgICogKGpzZG9jKSBlbmFibGVkIGNvbW1lbnQuIFRodXMsIHRoZSBhY3R1YWwgY29tbWVudCB0ZXh0IGZvciBDbG9zdXJlIG11c3QgaW5jbHVkZSB0aGUgYCpgIHRoYXRcbiAgICogdHVybnMgYSBgLypgIGNvbW1lbnQgaW50byBhIGAvKipgIGNvbW1lbnQsIGFzIHdlbGwgYXMgc3Vycm91bmRpbmcgd2hpdGVzcGFjZS5cbiAgICovXG4gIENMT1NVUkUgPSAnKiBAcHVyZU9yQnJlYWtNeUNvZGUgJyxcblxuICBURVJTRVIgPSAnQF9fUFVSRV9fJyxcbn1cblxuY29uc3QgVU5BUllfT1BFUkFUT1JTOiBSZWNvcmQ8VW5hcnlPcGVyYXRvciwgdHMuUHJlZml4VW5hcnlPcGVyYXRvcj4gPSB7XG4gICcrJzogdHMuU3ludGF4S2luZC5QbHVzVG9rZW4sXG4gICctJzogdHMuU3ludGF4S2luZC5NaW51c1Rva2VuLFxuICAnISc6IHRzLlN5bnRheEtpbmQuRXhjbGFtYXRpb25Ub2tlbixcbn07XG5cbmNvbnN0IEJJTkFSWV9PUEVSQVRPUlM6IFJlY29yZDxCaW5hcnlPcGVyYXRvciwgdHMuQmluYXJ5T3BlcmF0b3I+ID0ge1xuICAnJiYnOiB0cy5TeW50YXhLaW5kLkFtcGVyc2FuZEFtcGVyc2FuZFRva2VuLFxuICAnPic6IHRzLlN5bnRheEtpbmQuR3JlYXRlclRoYW5Ub2tlbixcbiAgJz49JzogdHMuU3ludGF4S2luZC5HcmVhdGVyVGhhbkVxdWFsc1Rva2VuLFxuICAnJic6IHRzLlN5bnRheEtpbmQuQW1wZXJzYW5kVG9rZW4sXG4gICcvJzogdHMuU3ludGF4S2luZC5TbGFzaFRva2VuLFxuICAnPT0nOiB0cy5TeW50YXhLaW5kLkVxdWFsc0VxdWFsc1Rva2VuLFxuICAnPT09JzogdHMuU3ludGF4S2luZC5FcXVhbHNFcXVhbHNFcXVhbHNUb2tlbixcbiAgJzwnOiB0cy5TeW50YXhLaW5kLkxlc3NUaGFuVG9rZW4sXG4gICc8PSc6IHRzLlN5bnRheEtpbmQuTGVzc1RoYW5FcXVhbHNUb2tlbixcbiAgJy0nOiB0cy5TeW50YXhLaW5kLk1pbnVzVG9rZW4sXG4gICclJzogdHMuU3ludGF4S2luZC5QZXJjZW50VG9rZW4sXG4gICcqJzogdHMuU3ludGF4S2luZC5Bc3Rlcmlza1Rva2VuLFxuICAnIT0nOiB0cy5TeW50YXhLaW5kLkV4Y2xhbWF0aW9uRXF1YWxzVG9rZW4sXG4gICchPT0nOiB0cy5TeW50YXhLaW5kLkV4Y2xhbWF0aW9uRXF1YWxzRXF1YWxzVG9rZW4sXG4gICd8fCc6IHRzLlN5bnRheEtpbmQuQmFyQmFyVG9rZW4sXG4gICcrJzogdHMuU3ludGF4S2luZC5QbHVzVG9rZW4sXG4gICc/Pyc6IHRzLlN5bnRheEtpbmQuUXVlc3Rpb25RdWVzdGlvblRva2VuLFxufTtcblxuY29uc3QgVkFSX1RZUEVTOiBSZWNvcmQ8VmFyaWFibGVEZWNsYXJhdGlvblR5cGUsIHRzLk5vZGVGbGFncz4gPSB7XG4gICdjb25zdCc6IHRzLk5vZGVGbGFncy5Db25zdCxcbiAgJ2xldCc6IHRzLk5vZGVGbGFncy5MZXQsXG4gICd2YXInOiB0cy5Ob2RlRmxhZ3MuTm9uZSxcbn07XG5cbi8qKlxuICogQSBUeXBlU2NyaXB0IGZsYXZvdXJlZCBpbXBsZW1lbnRhdGlvbiBvZiB0aGUgQXN0RmFjdG9yeS5cbiAqL1xuZXhwb3J0IGNsYXNzIFR5cGVTY3JpcHRBc3RGYWN0b3J5IGltcGxlbWVudHMgQXN0RmFjdG9yeTx0cy5TdGF0ZW1lbnQsIHRzLkV4cHJlc3Npb24+IHtcbiAgcHJpdmF0ZSBleHRlcm5hbFNvdXJjZUZpbGVzID0gbmV3IE1hcDxzdHJpbmcsIHRzLlNvdXJjZU1hcFNvdXJjZT4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFubm90YXRlRm9yQ2xvc3VyZUNvbXBpbGVyOiBib29sZWFuKSB7fVxuXG4gIGF0dGFjaENvbW1lbnRzID0gYXR0YWNoQ29tbWVudHM7XG5cbiAgY3JlYXRlQXJyYXlMaXRlcmFsID0gdHMuY3JlYXRlQXJyYXlMaXRlcmFsO1xuXG4gIGNyZWF0ZUFzc2lnbm1lbnQodGFyZ2V0OiB0cy5FeHByZXNzaW9uLCB2YWx1ZTogdHMuRXhwcmVzc2lvbik6IHRzLkV4cHJlc3Npb24ge1xuICAgIHJldHVybiB0cy5jcmVhdGVCaW5hcnkodGFyZ2V0LCB0cy5TeW50YXhLaW5kLkVxdWFsc1Rva2VuLCB2YWx1ZSk7XG4gIH1cblxuICBjcmVhdGVCaW5hcnlFeHByZXNzaW9uKFxuICAgICAgbGVmdE9wZXJhbmQ6IHRzLkV4cHJlc3Npb24sIG9wZXJhdG9yOiBCaW5hcnlPcGVyYXRvcixcbiAgICAgIHJpZ2h0T3BlcmFuZDogdHMuRXhwcmVzc2lvbik6IHRzLkV4cHJlc3Npb24ge1xuICAgIHJldHVybiB0cy5jcmVhdGVCaW5hcnkobGVmdE9wZXJhbmQsIEJJTkFSWV9PUEVSQVRPUlNbb3BlcmF0b3JdLCByaWdodE9wZXJhbmQpO1xuICB9XG5cbiAgY3JlYXRlQmxvY2soYm9keTogdHMuU3RhdGVtZW50W10pOiB0cy5TdGF0ZW1lbnQge1xuICAgIHJldHVybiB0cy5jcmVhdGVCbG9jayhib2R5KTtcbiAgfVxuXG4gIGNyZWF0ZUNhbGxFeHByZXNzaW9uKGNhbGxlZTogdHMuRXhwcmVzc2lvbiwgYXJnczogdHMuRXhwcmVzc2lvbltdLCBwdXJlOiBib29sZWFuKTogdHMuRXhwcmVzc2lvbiB7XG4gICAgY29uc3QgY2FsbCA9IHRzLmNyZWF0ZUNhbGwoY2FsbGVlLCB1bmRlZmluZWQsIGFyZ3MpO1xuICAgIGlmIChwdXJlKSB7XG4gICAgICB0cy5hZGRTeW50aGV0aWNMZWFkaW5nQ29tbWVudChcbiAgICAgICAgICBjYWxsLCB0cy5TeW50YXhLaW5kLk11bHRpTGluZUNvbW1lbnRUcml2aWEsXG4gICAgICAgICAgdGhpcy5hbm5vdGF0ZUZvckNsb3N1cmVDb21waWxlciA/IFB1cmVBbm5vdGF0aW9uLkNMT1NVUkUgOiBQdXJlQW5ub3RhdGlvbi5URVJTRVIsXG4gICAgICAgICAgLyogdHJhaWxpbmcgbmV3bGluZSAqLyBmYWxzZSk7XG4gICAgfVxuICAgIHJldHVybiBjYWxsO1xuICB9XG5cbiAgY3JlYXRlQ29uZGl0aW9uYWwgPSB0cy5jcmVhdGVDb25kaXRpb25hbDtcblxuICBjcmVhdGVFbGVtZW50QWNjZXNzID0gdHMuY3JlYXRlRWxlbWVudEFjY2VzcztcblxuICBjcmVhdGVFeHByZXNzaW9uU3RhdGVtZW50ID0gdHMuY3JlYXRlRXhwcmVzc2lvblN0YXRlbWVudDtcblxuICBjcmVhdGVGdW5jdGlvbkRlY2xhcmF0aW9uKGZ1bmN0aW9uTmFtZTogc3RyaW5nLCBwYXJhbWV0ZXJzOiBzdHJpbmdbXSwgYm9keTogdHMuU3RhdGVtZW50KTpcbiAgICAgIHRzLlN0YXRlbWVudCB7XG4gICAgaWYgKCF0cy5pc0Jsb2NrKGJvZHkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc3ludGF4LCBleHBlY3RlZCBhIGJsb2NrLCBidXQgZ290ICR7dHMuU3ludGF4S2luZFtib2R5LmtpbmRdfS5gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRzLmNyZWF0ZUZ1bmN0aW9uRGVjbGFyYXRpb24oXG4gICAgICAgIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGZ1bmN0aW9uTmFtZSwgdW5kZWZpbmVkLFxuICAgICAgICBwYXJhbWV0ZXJzLm1hcChwYXJhbSA9PiB0cy5jcmVhdGVQYXJhbWV0ZXIodW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgcGFyYW0pKSxcbiAgICAgICAgdW5kZWZpbmVkLCBib2R5KTtcbiAgfVxuXG4gIGNyZWF0ZUZ1bmN0aW9uRXhwcmVzc2lvbihmdW5jdGlvbk5hbWU6IHN0cmluZ3xudWxsLCBwYXJhbWV0ZXJzOiBzdHJpbmdbXSwgYm9keTogdHMuU3RhdGVtZW50KTpcbiAgICAgIHRzLkV4cHJlc3Npb24ge1xuICAgIGlmICghdHMuaXNCbG9jayhib2R5KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHN5bnRheCwgZXhwZWN0ZWQgYSBibG9jaywgYnV0IGdvdCAke3RzLlN5bnRheEtpbmRbYm9keS5raW5kXX0uYCk7XG4gICAgfVxuICAgIHJldHVybiB0cy5jcmVhdGVGdW5jdGlvbkV4cHJlc3Npb24oXG4gICAgICAgIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBmdW5jdGlvbk5hbWUgPz8gdW5kZWZpbmVkLCB1bmRlZmluZWQsXG4gICAgICAgIHBhcmFtZXRlcnMubWFwKHBhcmFtID0+IHRzLmNyZWF0ZVBhcmFtZXRlcih1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBwYXJhbSkpLFxuICAgICAgICB1bmRlZmluZWQsIGJvZHkpO1xuICB9XG5cbiAgY3JlYXRlSWRlbnRpZmllciA9IHRzLmNyZWF0ZUlkZW50aWZpZXI7XG5cbiAgY3JlYXRlSWZTdGF0ZW1lbnQoXG4gICAgICBjb25kaXRpb246IHRzLkV4cHJlc3Npb24sIHRoZW5TdGF0ZW1lbnQ6IHRzLlN0YXRlbWVudCxcbiAgICAgIGVsc2VTdGF0ZW1lbnQ6IHRzLlN0YXRlbWVudHxudWxsKTogdHMuU3RhdGVtZW50IHtcbiAgICByZXR1cm4gdHMuY3JlYXRlSWYoY29uZGl0aW9uLCB0aGVuU3RhdGVtZW50LCBlbHNlU3RhdGVtZW50ID8/IHVuZGVmaW5lZCk7XG4gIH1cblxuICBjcmVhdGVMaXRlcmFsKHZhbHVlOiBzdHJpbmd8bnVtYmVyfGJvb2xlYW58bnVsbHx1bmRlZmluZWQpOiB0cy5FeHByZXNzaW9uIHtcbiAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHRzLmNyZWF0ZUlkZW50aWZpZXIoJ3VuZGVmaW5lZCcpO1xuICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiB0cy5jcmVhdGVOdWxsKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0cy5jcmVhdGVMaXRlcmFsKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBjcmVhdGVOZXdFeHByZXNzaW9uKGV4cHJlc3Npb246IHRzLkV4cHJlc3Npb24sIGFyZ3M6IHRzLkV4cHJlc3Npb25bXSk6IHRzLkV4cHJlc3Npb24ge1xuICAgIHJldHVybiB0cy5jcmVhdGVOZXcoZXhwcmVzc2lvbiwgdW5kZWZpbmVkLCBhcmdzKTtcbiAgfVxuXG4gIGNyZWF0ZU9iamVjdExpdGVyYWwocHJvcGVydGllczogT2JqZWN0TGl0ZXJhbFByb3BlcnR5PHRzLkV4cHJlc3Npb24+W10pOiB0cy5FeHByZXNzaW9uIHtcbiAgICByZXR1cm4gdHMuY3JlYXRlT2JqZWN0TGl0ZXJhbChwcm9wZXJ0aWVzLm1hcChcbiAgICAgICAgcHJvcCA9PiB0cy5jcmVhdGVQcm9wZXJ0eUFzc2lnbm1lbnQoXG4gICAgICAgICAgICBwcm9wLnF1b3RlZCA/IHRzLmNyZWF0ZUxpdGVyYWwocHJvcC5wcm9wZXJ0eU5hbWUpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgdHMuY3JlYXRlSWRlbnRpZmllcihwcm9wLnByb3BlcnR5TmFtZSksXG4gICAgICAgICAgICBwcm9wLnZhbHVlKSkpO1xuICB9XG5cbiAgY3JlYXRlUGFyZW50aGVzaXplZEV4cHJlc3Npb24gPSB0cy5jcmVhdGVQYXJlbjtcblxuICBjcmVhdGVQcm9wZXJ0eUFjY2VzcyA9IHRzLmNyZWF0ZVByb3BlcnR5QWNjZXNzO1xuXG4gIGNyZWF0ZVJldHVyblN0YXRlbWVudChleHByZXNzaW9uOiB0cy5FeHByZXNzaW9ufG51bGwpOiB0cy5TdGF0ZW1lbnQge1xuICAgIHJldHVybiB0cy5jcmVhdGVSZXR1cm4oZXhwcmVzc2lvbiA/PyB1bmRlZmluZWQpO1xuICB9XG5cbiAgY3JlYXRlVGFnZ2VkVGVtcGxhdGUodGFnOiB0cy5FeHByZXNzaW9uLCB0ZW1wbGF0ZTogVGVtcGxhdGVMaXRlcmFsPHRzLkV4cHJlc3Npb24+KTpcbiAgICAgIHRzLkV4cHJlc3Npb24ge1xuICAgIGxldCB0ZW1wbGF0ZUxpdGVyYWw6IHRzLlRlbXBsYXRlTGl0ZXJhbDtcbiAgICBjb25zdCBsZW5ndGggPSB0ZW1wbGF0ZS5lbGVtZW50cy5sZW5ndGg7XG4gICAgY29uc3QgaGVhZCA9IHRlbXBsYXRlLmVsZW1lbnRzWzBdO1xuICAgIGlmIChsZW5ndGggPT09IDEpIHtcbiAgICAgIHRlbXBsYXRlTGl0ZXJhbCA9IHRzLmNyZWF0ZU5vU3Vic3RpdHV0aW9uVGVtcGxhdGVMaXRlcmFsKGhlYWQuY29va2VkLCBoZWFkLnJhdyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHNwYW5zOiB0cy5UZW1wbGF0ZVNwYW5bXSA9IFtdO1xuICAgICAgLy8gQ3JlYXRlIHRoZSBtaWRkbGUgcGFydHNcbiAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHtjb29rZWQsIHJhdywgcmFuZ2V9ID0gdGVtcGxhdGUuZWxlbWVudHNbaV07XG4gICAgICAgIGNvbnN0IG1pZGRsZSA9IGNyZWF0ZVRlbXBsYXRlTWlkZGxlKGNvb2tlZCwgcmF3KTtcbiAgICAgICAgaWYgKHJhbmdlICE9PSBudWxsKSB7XG4gICAgICAgICAgdGhpcy5zZXRTb3VyY2VNYXBSYW5nZShtaWRkbGUsIHJhbmdlKTtcbiAgICAgICAgfVxuICAgICAgICBzcGFucy5wdXNoKHRzLmNyZWF0ZVRlbXBsYXRlU3Bhbih0ZW1wbGF0ZS5leHByZXNzaW9uc1tpIC0gMV0sIG1pZGRsZSkpO1xuICAgICAgfVxuICAgICAgLy8gQ3JlYXRlIHRoZSB0YWlsIHBhcnRcbiAgICAgIGNvbnN0IHJlc29sdmVkRXhwcmVzc2lvbiA9IHRlbXBsYXRlLmV4cHJlc3Npb25zW2xlbmd0aCAtIDJdO1xuICAgICAgY29uc3QgdGVtcGxhdGVQYXJ0ID0gdGVtcGxhdGUuZWxlbWVudHNbbGVuZ3RoIC0gMV07XG4gICAgICBjb25zdCB0ZW1wbGF0ZVRhaWwgPSBjcmVhdGVUZW1wbGF0ZVRhaWwodGVtcGxhdGVQYXJ0LmNvb2tlZCwgdGVtcGxhdGVQYXJ0LnJhdyk7XG4gICAgICBpZiAodGVtcGxhdGVQYXJ0LnJhbmdlICE9PSBudWxsKSB7XG4gICAgICAgIHRoaXMuc2V0U291cmNlTWFwUmFuZ2UodGVtcGxhdGVUYWlsLCB0ZW1wbGF0ZVBhcnQucmFuZ2UpO1xuICAgICAgfVxuICAgICAgc3BhbnMucHVzaCh0cy5jcmVhdGVUZW1wbGF0ZVNwYW4ocmVzb2x2ZWRFeHByZXNzaW9uLCB0ZW1wbGF0ZVRhaWwpKTtcbiAgICAgIC8vIFB1dCBpdCBhbGwgdG9nZXRoZXJcbiAgICAgIHRlbXBsYXRlTGl0ZXJhbCA9XG4gICAgICAgICAgdHMuY3JlYXRlVGVtcGxhdGVFeHByZXNzaW9uKHRzLmNyZWF0ZVRlbXBsYXRlSGVhZChoZWFkLmNvb2tlZCwgaGVhZC5yYXcpLCBzcGFucyk7XG4gICAgfVxuICAgIGlmIChoZWFkLnJhbmdlICE9PSBudWxsKSB7XG4gICAgICB0aGlzLnNldFNvdXJjZU1hcFJhbmdlKHRlbXBsYXRlTGl0ZXJhbCwgaGVhZC5yYW5nZSk7XG4gICAgfVxuICAgIHJldHVybiB0cy5jcmVhdGVUYWdnZWRUZW1wbGF0ZSh0YWcsIHRlbXBsYXRlTGl0ZXJhbCk7XG4gIH1cblxuICBjcmVhdGVUaHJvd1N0YXRlbWVudCA9IHRzLmNyZWF0ZVRocm93O1xuXG4gIGNyZWF0ZVR5cGVPZkV4cHJlc3Npb24gPSB0cy5jcmVhdGVUeXBlT2Y7XG5cblxuICBjcmVhdGVVbmFyeUV4cHJlc3Npb24ob3BlcmF0b3I6IFVuYXJ5T3BlcmF0b3IsIG9wZXJhbmQ6IHRzLkV4cHJlc3Npb24pOiB0cy5FeHByZXNzaW9uIHtcbiAgICByZXR1cm4gdHMuY3JlYXRlUHJlZml4KFVOQVJZX09QRVJBVE9SU1tvcGVyYXRvcl0sIG9wZXJhbmQpO1xuICB9XG5cbiAgY3JlYXRlVmFyaWFibGVEZWNsYXJhdGlvbihcbiAgICAgIHZhcmlhYmxlTmFtZTogc3RyaW5nLCBpbml0aWFsaXplcjogdHMuRXhwcmVzc2lvbnxudWxsLFxuICAgICAgdHlwZTogVmFyaWFibGVEZWNsYXJhdGlvblR5cGUpOiB0cy5TdGF0ZW1lbnQge1xuICAgIHJldHVybiB0cy5jcmVhdGVWYXJpYWJsZVN0YXRlbWVudChcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICB0cy5jcmVhdGVWYXJpYWJsZURlY2xhcmF0aW9uTGlzdChcbiAgICAgICAgICAgIFt0cy5jcmVhdGVWYXJpYWJsZURlY2xhcmF0aW9uKHZhcmlhYmxlTmFtZSwgdW5kZWZpbmVkLCBpbml0aWFsaXplciA/PyB1bmRlZmluZWQpXSxcbiAgICAgICAgICAgIFZBUl9UWVBFU1t0eXBlXSksXG4gICAgKTtcbiAgfVxuXG4gIHNldFNvdXJjZU1hcFJhbmdlPFQgZXh0ZW5kcyB0cy5Ob2RlPihub2RlOiBULCBzb3VyY2VNYXBSYW5nZTogU291cmNlTWFwUmFuZ2V8bnVsbCk6IFQge1xuICAgIGlmIChzb3VyY2VNYXBSYW5nZSA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIG5vZGU7XG4gICAgfVxuXG4gICAgY29uc3QgdXJsID0gc291cmNlTWFwUmFuZ2UudXJsO1xuICAgIGlmICghdGhpcy5leHRlcm5hbFNvdXJjZUZpbGVzLmhhcyh1cmwpKSB7XG4gICAgICB0aGlzLmV4dGVybmFsU291cmNlRmlsZXMuc2V0KFxuICAgICAgICAgIHVybCwgdHMuY3JlYXRlU291cmNlTWFwU291cmNlKHVybCwgc291cmNlTWFwUmFuZ2UuY29udGVudCwgcG9zID0+IHBvcykpO1xuICAgIH1cbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzLmV4dGVybmFsU291cmNlRmlsZXMuZ2V0KHVybCk7XG4gICAgdHMuc2V0U291cmNlTWFwUmFuZ2UoXG4gICAgICAgIG5vZGUsIHtwb3M6IHNvdXJjZU1hcFJhbmdlLnN0YXJ0Lm9mZnNldCwgZW5kOiBzb3VyY2VNYXBSYW5nZS5lbmQub2Zmc2V0LCBzb3VyY2V9KTtcbiAgICByZXR1cm4gbm9kZTtcbiAgfVxufVxuXG4vLyBIQUNLOiBVc2UgdGhpcyBpbiBwbGFjZSBvZiBgdHMuY3JlYXRlVGVtcGxhdGVNaWRkbGUoKWAuXG4vLyBSZXZlcnQgb25jZSBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L1R5cGVTY3JpcHQvaXNzdWVzLzM1Mzc0IGlzIGZpeGVkLlxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVRlbXBsYXRlTWlkZGxlKGNvb2tlZDogc3RyaW5nLCByYXc6IHN0cmluZyk6IHRzLlRlbXBsYXRlTWlkZGxlIHtcbiAgY29uc3Qgbm9kZTogdHMuVGVtcGxhdGVMaXRlcmFsTGlrZU5vZGUgPSB0cy5jcmVhdGVUZW1wbGF0ZUhlYWQoY29va2VkLCByYXcpO1xuICAobm9kZS5raW5kIGFzIHRzLlN5bnRheEtpbmQpID0gdHMuU3ludGF4S2luZC5UZW1wbGF0ZU1pZGRsZTtcbiAgcmV0dXJuIG5vZGUgYXMgdHMuVGVtcGxhdGVNaWRkbGU7XG59XG5cbi8vIEhBQ0s6IFVzZSB0aGlzIGluIHBsYWNlIG9mIGB0cy5jcmVhdGVUZW1wbGF0ZVRhaWwoKWAuXG4vLyBSZXZlcnQgb25jZSBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L1R5cGVTY3JpcHQvaXNzdWVzLzM1Mzc0IGlzIGZpeGVkLlxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVRlbXBsYXRlVGFpbChjb29rZWQ6IHN0cmluZywgcmF3OiBzdHJpbmcpOiB0cy5UZW1wbGF0ZVRhaWwge1xuICBjb25zdCBub2RlOiB0cy5UZW1wbGF0ZUxpdGVyYWxMaWtlTm9kZSA9IHRzLmNyZWF0ZVRlbXBsYXRlSGVhZChjb29rZWQsIHJhdyk7XG4gIChub2RlLmtpbmQgYXMgdHMuU3ludGF4S2luZCkgPSB0cy5TeW50YXhLaW5kLlRlbXBsYXRlVGFpbDtcbiAgcmV0dXJuIG5vZGUgYXMgdHMuVGVtcGxhdGVUYWlsO1xufVxuXG4vKipcbiAqIEF0dGFjaCB0aGUgZ2l2ZW4gYGxlYWRpbmdDb21tZW50c2AgdG8gdGhlIGBzdGF0ZW1lbnRgIG5vZGUuXG4gKlxuICogQHBhcmFtIHN0YXRlbWVudCBUaGUgc3RhdGVtZW50IHRoYXQgd2lsbCBoYXZlIGNvbW1lbnRzIGF0dGFjaGVkLlxuICogQHBhcmFtIGxlYWRpbmdDb21tZW50cyBUaGUgY29tbWVudHMgdG8gYXR0YWNoIHRvIHRoZSBzdGF0ZW1lbnQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hDb21tZW50cyhzdGF0ZW1lbnQ6IHRzLlN0YXRlbWVudCwgbGVhZGluZ0NvbW1lbnRzOiBMZWFkaW5nQ29tbWVudFtdKTogdm9pZCB7XG4gIGZvciAoY29uc3QgY29tbWVudCBvZiBsZWFkaW5nQ29tbWVudHMpIHtcbiAgICBjb25zdCBjb21tZW50S2luZCA9IGNvbW1lbnQubXVsdGlsaW5lID8gdHMuU3ludGF4S2luZC5NdWx0aUxpbmVDb21tZW50VHJpdmlhIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHMuU3ludGF4S2luZC5TaW5nbGVMaW5lQ29tbWVudFRyaXZpYTtcbiAgICBpZiAoY29tbWVudC5tdWx0aWxpbmUpIHtcbiAgICAgIHRzLmFkZFN5bnRoZXRpY0xlYWRpbmdDb21tZW50KFxuICAgICAgICAgIHN0YXRlbWVudCwgY29tbWVudEtpbmQsIGNvbW1lbnQudG9TdHJpbmcoKSwgY29tbWVudC50cmFpbGluZ05ld2xpbmUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKGNvbnN0IGxpbmUgb2YgY29tbWVudC50b1N0cmluZygpLnNwbGl0KCdcXG4nKSkge1xuICAgICAgICB0cy5hZGRTeW50aGV0aWNMZWFkaW5nQ29tbWVudChzdGF0ZW1lbnQsIGNvbW1lbnRLaW5kLCBsaW5lLCBjb21tZW50LnRyYWlsaW5nTmV3bGluZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=