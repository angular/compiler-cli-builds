{"version":3,"file":"codegen.js","sourceRoot":"","sources":["../../../../packages/compiler-cli/src/codegen.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\n/**\n * Transform template html and css into executable code.\n * Intended to be used in a build step.\n */\nimport * as compiler from '@angular/compiler';\nimport {readFileSync} from 'fs';\nimport * as ts from 'typescript';\n\nimport {CompilerHost, CompilerHostContext, ModuleResolutionHostAdapter} from './compiler_host';\nimport {PathMappedCompilerHost} from './path_mapped_compiler_host';\nimport {CompilerOptions} from './transformers/api';\n\nconst GENERATED_META_FILES = /\\.json$/;\n\nconst PREAMBLE = `/**\n * @fileoverview This file is generated by the Angular template compiler.\n * Do not edit.\n * @suppress {suspiciousCode,uselessCode,missingProperties,missingOverride}\n */\n /* tslint:disable */\n\n`;\n\nexport interface CodeGeneratorI18nOptions {\n  i18nFormat: string|null;\n  i18nFile: string|null;\n  locale: string|null;\n  missingTranslation: string|null;\n}\n\n// TODO(tbosch): remove this once G3 uses the transformer compiler!\nexport class CodeGenerator {\n  constructor(\n      private options: CompilerOptions, private program: ts.Program, public host: ts.CompilerHost,\n      private compiler: compiler.AotCompiler, private ngCompilerHost: CompilerHost) {}\n\n  codegen(): Promise<string[]> {\n    return this.compiler\n        .analyzeModulesAsync(this.program.getSourceFiles().map(\n            sf => this.ngCompilerHost.getCanonicalFileName(sf.fileName)))\n        .then(analyzedModules => this.emit(analyzedModules));\n  }\n\n  codegenSync(): string[] {\n    const analyzed = this.compiler.analyzeModulesSync(this.program.getSourceFiles().map(\n        sf => this.ngCompilerHost.getCanonicalFileName(sf.fileName)));\n    return this.emit(analyzed);\n  }\n\n  private emit(analyzedModules: compiler.NgAnalyzedModules) {\n    const generatedModules = this.compiler.emitAllImpls(analyzedModules);\n    return generatedModules.map(generatedModule => {\n      const sourceFile = this.program.getSourceFile(generatedModule.srcFileName);\n      const emitPath = this.ngCompilerHost.calculateEmitPath(generatedModule.genFileName);\n      const source = generatedModule.source || compiler.toTypeScript(generatedModule, PREAMBLE);\n      this.host.writeFile(emitPath, source, false, () => {}, [sourceFile]);\n      return emitPath;\n    });\n  }\n\n  static create(\n      options: CompilerOptions, i18nOptions: CodeGeneratorI18nOptions, program: ts.Program,\n      tsCompilerHost: ts.CompilerHost, compilerHostContext?: CompilerHostContext,\n      ngCompilerHost?: CompilerHost): CodeGenerator {\n    if (!ngCompilerHost) {\n      const usePathMapping = !!options.rootDirs && options.rootDirs.length > 0;\n      const context = compilerHostContext || new ModuleResolutionHostAdapter(tsCompilerHost);\n      ngCompilerHost = usePathMapping ? new PathMappedCompilerHost(program, options, context) :\n                                        new CompilerHost(program, options, context);\n    }\n    let transContent: string = '';\n    if (i18nOptions.i18nFile) {\n      if (!i18nOptions.locale) {\n        throw new Error(\n            `The translation file (${i18nOptions.i18nFile}) locale must be provided. Use the --locale option.`);\n      }\n      transContent = readFileSync(i18nOptions.i18nFile, 'utf8');\n    }\n    let missingTranslation = compiler.core.MissingTranslationStrategy.Warning;\n    if (i18nOptions.missingTranslation) {\n      switch (i18nOptions.missingTranslation) {\n        case 'error':\n          missingTranslation = compiler.core.MissingTranslationStrategy.Error;\n          break;\n        case 'warning':\n          missingTranslation = compiler.core.MissingTranslationStrategy.Warning;\n          break;\n        case 'ignore':\n          missingTranslation = compiler.core.MissingTranslationStrategy.Ignore;\n          break;\n        default:\n          throw new Error(\n              `Unknown option for missingTranslation (${i18nOptions.missingTranslation}). Use either error, warning or ignore.`);\n      }\n    }\n    if (!transContent) {\n      missingTranslation = compiler.core.MissingTranslationStrategy.Ignore;\n    }\n    const {compiler: aotCompiler} = compiler.createAotCompiler(ngCompilerHost, {\n      translations: transContent,\n      i18nFormat: i18nOptions.i18nFormat || undefined,\n      locale: i18nOptions.locale || undefined, missingTranslation,\n      enableLegacyTemplate: options.enableLegacyTemplate === true,\n      enableSummariesForJit: options.enableSummariesForJit !== false,\n      preserveWhitespaces: options.preserveWhitespaces,\n    });\n    return new CodeGenerator(options, program, tsCompilerHost, aotCompiler, ngCompilerHost);\n  }\n}\n"]}