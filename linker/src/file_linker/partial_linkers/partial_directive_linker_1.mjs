/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { compileDirectiveFromMetadata, makeBindingParser, ParseLocation, ParseSourceFile, ParseSourceSpan } from '@angular/compiler';
import { FatalLinkerError } from '../../fatal_linker_error';
import { wrapReference } from './util';
/**
 * A `PartialLinker` that is designed to process `ɵɵngDeclareDirective()` call expressions.
 */
export class PartialDirectiveLinkerVersion1 {
    constructor(sourceUrl, code) {
        this.sourceUrl = sourceUrl;
        this.code = code;
    }
    linkPartialDeclaration(constantPool, metaObj) {
        const meta = toR3DirectiveMeta(metaObj, this.code, this.sourceUrl);
        const def = compileDirectiveFromMetadata(meta, constantPool, makeBindingParser());
        return def.expression;
    }
}
/**
 * Derives the `R3DirectiveMetadata` structure from the AST object.
 */
export function toR3DirectiveMeta(metaObj, code, sourceUrl) {
    const typeExpr = metaObj.getValue('type');
    const typeName = typeExpr.getSymbolName();
    if (typeName === null) {
        throw new FatalLinkerError(typeExpr.expression, 'Unsupported type, its name could not be determined');
    }
    return {
        typeSourceSpan: createSourceSpan(typeExpr.getRange(), code, sourceUrl),
        type: wrapReference(typeExpr.getOpaque()),
        typeArgumentCount: 0,
        internalType: metaObj.getOpaque('type'),
        deps: null,
        host: toHostMetadata(metaObj),
        inputs: metaObj.has('inputs') ? metaObj.getObject('inputs').toLiteral(toInputMapping) : {},
        outputs: metaObj.has('outputs') ?
            metaObj.getObject('outputs').toLiteral(value => value.getString()) :
            {},
        queries: metaObj.has('queries') ?
            metaObj.getArray('queries').map(entry => toQueryMetadata(entry.getObject())) :
            [],
        viewQueries: metaObj.has('viewQueries') ?
            metaObj.getArray('viewQueries').map(entry => toQueryMetadata(entry.getObject())) :
            [],
        providers: metaObj.has('providers') ? metaObj.getOpaque('providers') : null,
        fullInheritance: false,
        selector: metaObj.has('selector') ? metaObj.getString('selector') : null,
        exportAs: metaObj.has('exportAs') ?
            metaObj.getArray('exportAs').map(entry => entry.getString()) :
            null,
        lifecycle: {
            usesOnChanges: metaObj.has('usesOnChanges') ? metaObj.getBoolean('usesOnChanges') : false,
        },
        name: typeName,
        usesInheritance: metaObj.has('usesInheritance') ? metaObj.getBoolean('usesInheritance') : false,
    };
}
/**
 * Decodes the AST value for a single input to its representation as used in the metadata.
 */
function toInputMapping(value) {
    if (value.isString()) {
        return value.getString();
    }
    const values = value.getArray().map(innerValue => innerValue.getString());
    if (values.length !== 2) {
        throw new FatalLinkerError(value.expression, 'Unsupported input, expected a string or an array containing exactly two strings');
    }
    return values;
}
/**
 * Extracts the host metadata configuration from the AST metadata object.
 */
function toHostMetadata(metaObj) {
    if (!metaObj.has('host')) {
        return {
            attributes: {},
            listeners: {},
            properties: {},
            specialAttributes: {},
        };
    }
    const host = metaObj.getObject('host');
    const specialAttributes = {};
    if (host.has('styleAttribute')) {
        specialAttributes.styleAttr = host.getString('styleAttribute');
    }
    if (host.has('classAttribute')) {
        specialAttributes.classAttr = host.getString('classAttribute');
    }
    return {
        attributes: host.has('attributes') ?
            host.getObject('attributes').toLiteral(value => value.getOpaque()) :
            {},
        listeners: host.has('listeners') ?
            host.getObject('listeners').toLiteral(value => value.getString()) :
            {},
        properties: host.has('properties') ?
            host.getObject('properties').toLiteral(value => value.getString()) :
            {},
        specialAttributes,
    };
}
/**
 * Extracts the metadata for a single query from an AST object.
 */
function toQueryMetadata(obj) {
    let predicate;
    const predicateExpr = obj.getValue('predicate');
    if (predicateExpr.isArray()) {
        predicate = predicateExpr.getArray().map(entry => entry.getString());
    }
    else {
        predicate = predicateExpr.getOpaque();
    }
    return {
        propertyName: obj.getString('propertyName'),
        first: obj.has('first') ? obj.getBoolean('first') : false,
        predicate,
        descendants: obj.has('descendants') ? obj.getBoolean('descendants') : false,
        emitDistinctChangesOnly: obj.has('emitDistinctChangesOnly') ? obj.getBoolean('emitDistinctChangesOnly') : true,
        read: obj.has('read') ? obj.getOpaque('read') : null,
        static: obj.has('static') ? obj.getBoolean('static') : false,
    };
}
export function createSourceSpan(range, code, sourceUrl) {
    const sourceFile = new ParseSourceFile(code, sourceUrl);
    const startLocation = new ParseLocation(sourceFile, range.startPos, range.startLine, range.startCol);
    return new ParseSourceSpan(startLocation, startLocation.moveBy(range.endPos - range.startPos));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFydGlhbF9kaXJlY3RpdmVfbGlua2VyXzEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb21waWxlci1jbGkvbGlua2VyL3NyYy9maWxlX2xpbmtlci9wYXJ0aWFsX2xpbmtlcnMvcGFydGlhbF9kaXJlY3RpdmVfbGlua2VyXzEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBQ0gsT0FBTyxFQUFDLDRCQUE0QixFQUFnQixpQkFBaUIsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLGVBQWUsRUFBaUksTUFBTSxtQkFBbUIsQ0FBQztBQU1qUixPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUcxRCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sUUFBUSxDQUFDO0FBRXJDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDhCQUE4QjtJQUN6QyxZQUFvQixTQUF5QixFQUFVLElBQVk7UUFBL0MsY0FBUyxHQUFULFNBQVMsQ0FBZ0I7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFRO0lBQUcsQ0FBQztJQUV2RSxzQkFBc0IsQ0FDbEIsWUFBMEIsRUFDMUIsT0FBcUQ7UUFDdkQsTUFBTSxJQUFJLEdBQUcsaUJBQWlCLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ25FLE1BQU0sR0FBRyxHQUFHLDRCQUE0QixDQUFDLElBQUksRUFBRSxZQUFZLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO1FBQ2xGLE9BQU8sR0FBRyxDQUFDLFVBQVUsQ0FBQztJQUN4QixDQUFDO0NBQ0Y7QUFFRDs7R0FFRztBQUNILE1BQU0sVUFBVSxpQkFBaUIsQ0FDN0IsT0FBMkQsRUFBRSxJQUFZLEVBQ3pFLFNBQXlCO0lBQzNCLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDMUMsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQzFDLElBQUksUUFBUSxLQUFLLElBQUksRUFBRTtRQUNyQixNQUFNLElBQUksZ0JBQWdCLENBQ3RCLFFBQVEsQ0FBQyxVQUFVLEVBQUUsb0RBQW9ELENBQUMsQ0FBQztLQUNoRjtJQUVELE9BQU87UUFDTCxjQUFjLEVBQUUsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLENBQUM7UUFDdEUsSUFBSSxFQUFFLGFBQWEsQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDekMsaUJBQWlCLEVBQUUsQ0FBQztRQUNwQixZQUFZLEVBQUUsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUM7UUFDdkMsSUFBSSxFQUFFLElBQUk7UUFDVixJQUFJLEVBQUUsY0FBYyxDQUFDLE9BQU8sQ0FBQztRQUM3QixNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDMUYsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztZQUM3QixPQUFPLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDcEUsRUFBRTtRQUNOLE9BQU8sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDN0IsT0FBTyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlFLEVBQUU7UUFDTixXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLE9BQU8sQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsRixFQUFFO1FBQ04sU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7UUFDM0UsZUFBZSxFQUFFLEtBQUs7UUFDdEIsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7UUFDeEUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUMvQixPQUFPLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDOUQsSUFBSTtRQUNSLFNBQVMsRUFBRTtZQUNULGFBQWEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLO1NBQzFGO1FBQ0QsSUFBSSxFQUFFLFFBQVE7UUFDZCxlQUFlLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7S0FDaEcsQ0FBQztBQUNKLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsY0FBYyxDQUFjLEtBQXFEO0lBRXhGLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFO1FBQ3BCLE9BQU8sS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO0tBQzFCO0lBRUQsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO0lBQzFFLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDdkIsTUFBTSxJQUFJLGdCQUFnQixDQUN0QixLQUFLLENBQUMsVUFBVSxFQUNoQixpRkFBaUYsQ0FBQyxDQUFDO0tBQ3hGO0lBQ0QsT0FBTyxNQUEwQixDQUFDO0FBQ3BDLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsY0FBYyxDQUFjLE9BQTJEO0lBRTlGLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQ3hCLE9BQU87WUFDTCxVQUFVLEVBQUUsRUFBRTtZQUNkLFNBQVMsRUFBRSxFQUFFO1lBQ2IsVUFBVSxFQUFFLEVBQUU7WUFDZCxpQkFBaUIsRUFBRSxFQUFFO1NBQ3RCLENBQUM7S0FDSDtJQUVELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFdkMsTUFBTSxpQkFBaUIsR0FBd0MsRUFBRSxDQUFDO0lBQ2xFLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO1FBQzlCLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLENBQUM7S0FDaEU7SUFDRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtRQUM5QixpQkFBaUIsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0tBQ2hFO0lBRUQsT0FBTztRQUNMLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLEVBQUU7UUFDTixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQzlCLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNuRSxFQUFFO1FBQ04sVUFBVSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDcEUsRUFBRTtRQUNOLGlCQUFpQjtLQUNsQixDQUFDO0FBQ0osQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxlQUFlLENBQWMsR0FBbUQ7SUFFdkYsSUFBSSxTQUF1QyxDQUFDO0lBQzVDLE1BQU0sYUFBYSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDaEQsSUFBSSxhQUFhLENBQUMsT0FBTyxFQUFFLEVBQUU7UUFDM0IsU0FBUyxHQUFHLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztLQUN0RTtTQUFNO1FBQ0wsU0FBUyxHQUFHLGFBQWEsQ0FBQyxTQUFTLEVBQUUsQ0FBQztLQUN2QztJQUNELE9BQU87UUFDTCxZQUFZLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUM7UUFDM0MsS0FBSyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7UUFDekQsU0FBUztRQUNULFdBQVcsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLO1FBQzNFLHVCQUF1QixFQUNuQixHQUFHLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtRQUN6RixJQUFJLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtRQUNwRCxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSztLQUM3RCxDQUFDO0FBQ0osQ0FBQztBQUVELE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxLQUFZLEVBQUUsSUFBWSxFQUFFLFNBQWlCO0lBQzVFLE1BQU0sVUFBVSxHQUFHLElBQUksZUFBZSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN4RCxNQUFNLGFBQWEsR0FDZixJQUFJLGFBQWEsQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuRixPQUFPLElBQUksZUFBZSxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDakcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCBHb29nbGUgTExDIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuaW1wb3J0IHtjb21waWxlRGlyZWN0aXZlRnJvbU1ldGFkYXRhLCBDb25zdGFudFBvb2wsIG1ha2VCaW5kaW5nUGFyc2VyLCBQYXJzZUxvY2F0aW9uLCBQYXJzZVNvdXJjZUZpbGUsIFBhcnNlU291cmNlU3BhbiwgUjNEZWNsYXJlRGlyZWN0aXZlTWV0YWRhdGEsIFIzRGVjbGFyZVF1ZXJ5TWV0YWRhdGEsIFIzRGlyZWN0aXZlTWV0YWRhdGEsIFIzSG9zdE1ldGFkYXRhLCBSM1BhcnRpYWxEZWNsYXJhdGlvbiwgUjNRdWVyeU1ldGFkYXRhfSBmcm9tICdAYW5ndWxhci9jb21waWxlcic7XG5pbXBvcnQgKiBhcyBvIGZyb20gJ0Bhbmd1bGFyL2NvbXBpbGVyL3NyYy9vdXRwdXQvb3V0cHV0X2FzdCc7XG5cbmltcG9ydCB7QWJzb2x1dGVGc1BhdGh9IGZyb20gJy4uLy4uLy4uLy4uL3NyYy9uZ3RzYy9maWxlX3N5c3RlbSc7XG5pbXBvcnQge1JhbmdlfSBmcm9tICcuLi8uLi9hc3QvYXN0X2hvc3QnO1xuaW1wb3J0IHtBc3RPYmplY3QsIEFzdFZhbHVlfSBmcm9tICcuLi8uLi9hc3QvYXN0X3ZhbHVlJztcbmltcG9ydCB7RmF0YWxMaW5rZXJFcnJvcn0gZnJvbSAnLi4vLi4vZmF0YWxfbGlua2VyX2Vycm9yJztcblxuaW1wb3J0IHtQYXJ0aWFsTGlua2VyfSBmcm9tICcuL3BhcnRpYWxfbGlua2VyJztcbmltcG9ydCB7d3JhcFJlZmVyZW5jZX0gZnJvbSAnLi91dGlsJztcblxuLyoqXG4gKiBBIGBQYXJ0aWFsTGlua2VyYCB0aGF0IGlzIGRlc2lnbmVkIHRvIHByb2Nlc3MgYMm1ybVuZ0RlY2xhcmVEaXJlY3RpdmUoKWAgY2FsbCBleHByZXNzaW9ucy5cbiAqL1xuZXhwb3J0IGNsYXNzIFBhcnRpYWxEaXJlY3RpdmVMaW5rZXJWZXJzaW9uMTxURXhwcmVzc2lvbj4gaW1wbGVtZW50cyBQYXJ0aWFsTGlua2VyPFRFeHByZXNzaW9uPiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgc291cmNlVXJsOiBBYnNvbHV0ZUZzUGF0aCwgcHJpdmF0ZSBjb2RlOiBzdHJpbmcpIHt9XG5cbiAgbGlua1BhcnRpYWxEZWNsYXJhdGlvbihcbiAgICAgIGNvbnN0YW50UG9vbDogQ29uc3RhbnRQb29sLFxuICAgICAgbWV0YU9iajogQXN0T2JqZWN0PFIzUGFydGlhbERlY2xhcmF0aW9uLCBURXhwcmVzc2lvbj4pOiBvLkV4cHJlc3Npb24ge1xuICAgIGNvbnN0IG1ldGEgPSB0b1IzRGlyZWN0aXZlTWV0YShtZXRhT2JqLCB0aGlzLmNvZGUsIHRoaXMuc291cmNlVXJsKTtcbiAgICBjb25zdCBkZWYgPSBjb21waWxlRGlyZWN0aXZlRnJvbU1ldGFkYXRhKG1ldGEsIGNvbnN0YW50UG9vbCwgbWFrZUJpbmRpbmdQYXJzZXIoKSk7XG4gICAgcmV0dXJuIGRlZi5leHByZXNzaW9uO1xuICB9XG59XG5cbi8qKlxuICogRGVyaXZlcyB0aGUgYFIzRGlyZWN0aXZlTWV0YWRhdGFgIHN0cnVjdHVyZSBmcm9tIHRoZSBBU1Qgb2JqZWN0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gdG9SM0RpcmVjdGl2ZU1ldGE8VEV4cHJlc3Npb24+KFxuICAgIG1ldGFPYmo6IEFzdE9iamVjdDxSM0RlY2xhcmVEaXJlY3RpdmVNZXRhZGF0YSwgVEV4cHJlc3Npb24+LCBjb2RlOiBzdHJpbmcsXG4gICAgc291cmNlVXJsOiBBYnNvbHV0ZUZzUGF0aCk6IFIzRGlyZWN0aXZlTWV0YWRhdGEge1xuICBjb25zdCB0eXBlRXhwciA9IG1ldGFPYmouZ2V0VmFsdWUoJ3R5cGUnKTtcbiAgY29uc3QgdHlwZU5hbWUgPSB0eXBlRXhwci5nZXRTeW1ib2xOYW1lKCk7XG4gIGlmICh0eXBlTmFtZSA9PT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBGYXRhbExpbmtlckVycm9yKFxuICAgICAgICB0eXBlRXhwci5leHByZXNzaW9uLCAnVW5zdXBwb3J0ZWQgdHlwZSwgaXRzIG5hbWUgY291bGQgbm90IGJlIGRldGVybWluZWQnKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgdHlwZVNvdXJjZVNwYW46IGNyZWF0ZVNvdXJjZVNwYW4odHlwZUV4cHIuZ2V0UmFuZ2UoKSwgY29kZSwgc291cmNlVXJsKSxcbiAgICB0eXBlOiB3cmFwUmVmZXJlbmNlKHR5cGVFeHByLmdldE9wYXF1ZSgpKSxcbiAgICB0eXBlQXJndW1lbnRDb3VudDogMCxcbiAgICBpbnRlcm5hbFR5cGU6IG1ldGFPYmouZ2V0T3BhcXVlKCd0eXBlJyksXG4gICAgZGVwczogbnVsbCxcbiAgICBob3N0OiB0b0hvc3RNZXRhZGF0YShtZXRhT2JqKSxcbiAgICBpbnB1dHM6IG1ldGFPYmouaGFzKCdpbnB1dHMnKSA/IG1ldGFPYmouZ2V0T2JqZWN0KCdpbnB1dHMnKS50b0xpdGVyYWwodG9JbnB1dE1hcHBpbmcpIDoge30sXG4gICAgb3V0cHV0czogbWV0YU9iai5oYXMoJ291dHB1dHMnKSA/XG4gICAgICAgIG1ldGFPYmouZ2V0T2JqZWN0KCdvdXRwdXRzJykudG9MaXRlcmFsKHZhbHVlID0+IHZhbHVlLmdldFN0cmluZygpKSA6XG4gICAgICAgIHt9LFxuICAgIHF1ZXJpZXM6IG1ldGFPYmouaGFzKCdxdWVyaWVzJykgP1xuICAgICAgICBtZXRhT2JqLmdldEFycmF5KCdxdWVyaWVzJykubWFwKGVudHJ5ID0+IHRvUXVlcnlNZXRhZGF0YShlbnRyeS5nZXRPYmplY3QoKSkpIDpcbiAgICAgICAgW10sXG4gICAgdmlld1F1ZXJpZXM6IG1ldGFPYmouaGFzKCd2aWV3UXVlcmllcycpID9cbiAgICAgICAgbWV0YU9iai5nZXRBcnJheSgndmlld1F1ZXJpZXMnKS5tYXAoZW50cnkgPT4gdG9RdWVyeU1ldGFkYXRhKGVudHJ5LmdldE9iamVjdCgpKSkgOlxuICAgICAgICBbXSxcbiAgICBwcm92aWRlcnM6IG1ldGFPYmouaGFzKCdwcm92aWRlcnMnKSA/IG1ldGFPYmouZ2V0T3BhcXVlKCdwcm92aWRlcnMnKSA6IG51bGwsXG4gICAgZnVsbEluaGVyaXRhbmNlOiBmYWxzZSxcbiAgICBzZWxlY3RvcjogbWV0YU9iai5oYXMoJ3NlbGVjdG9yJykgPyBtZXRhT2JqLmdldFN0cmluZygnc2VsZWN0b3InKSA6IG51bGwsXG4gICAgZXhwb3J0QXM6IG1ldGFPYmouaGFzKCdleHBvcnRBcycpID9cbiAgICAgICAgbWV0YU9iai5nZXRBcnJheSgnZXhwb3J0QXMnKS5tYXAoZW50cnkgPT4gZW50cnkuZ2V0U3RyaW5nKCkpIDpcbiAgICAgICAgbnVsbCxcbiAgICBsaWZlY3ljbGU6IHtcbiAgICAgIHVzZXNPbkNoYW5nZXM6IG1ldGFPYmouaGFzKCd1c2VzT25DaGFuZ2VzJykgPyBtZXRhT2JqLmdldEJvb2xlYW4oJ3VzZXNPbkNoYW5nZXMnKSA6IGZhbHNlLFxuICAgIH0sXG4gICAgbmFtZTogdHlwZU5hbWUsXG4gICAgdXNlc0luaGVyaXRhbmNlOiBtZXRhT2JqLmhhcygndXNlc0luaGVyaXRhbmNlJykgPyBtZXRhT2JqLmdldEJvb2xlYW4oJ3VzZXNJbmhlcml0YW5jZScpIDogZmFsc2UsXG4gIH07XG59XG5cbi8qKlxuICogRGVjb2RlcyB0aGUgQVNUIHZhbHVlIGZvciBhIHNpbmdsZSBpbnB1dCB0byBpdHMgcmVwcmVzZW50YXRpb24gYXMgdXNlZCBpbiB0aGUgbWV0YWRhdGEuXG4gKi9cbmZ1bmN0aW9uIHRvSW5wdXRNYXBwaW5nPFRFeHByZXNzaW9uPih2YWx1ZTogQXN0VmFsdWU8c3RyaW5nfFtzdHJpbmcsIHN0cmluZ10sIFRFeHByZXNzaW9uPik6XG4gICAgc3RyaW5nfFtzdHJpbmcsIHN0cmluZ10ge1xuICBpZiAodmFsdWUuaXNTdHJpbmcoKSkge1xuICAgIHJldHVybiB2YWx1ZS5nZXRTdHJpbmcoKTtcbiAgfVxuXG4gIGNvbnN0IHZhbHVlcyA9IHZhbHVlLmdldEFycmF5KCkubWFwKGlubmVyVmFsdWUgPT4gaW5uZXJWYWx1ZS5nZXRTdHJpbmcoKSk7XG4gIGlmICh2YWx1ZXMubGVuZ3RoICE9PSAyKSB7XG4gICAgdGhyb3cgbmV3IEZhdGFsTGlua2VyRXJyb3IoXG4gICAgICAgIHZhbHVlLmV4cHJlc3Npb24sXG4gICAgICAgICdVbnN1cHBvcnRlZCBpbnB1dCwgZXhwZWN0ZWQgYSBzdHJpbmcgb3IgYW4gYXJyYXkgY29udGFpbmluZyBleGFjdGx5IHR3byBzdHJpbmdzJyk7XG4gIH1cbiAgcmV0dXJuIHZhbHVlcyBhcyBbc3RyaW5nLCBzdHJpbmddO1xufVxuXG4vKipcbiAqIEV4dHJhY3RzIHRoZSBob3N0IG1ldGFkYXRhIGNvbmZpZ3VyYXRpb24gZnJvbSB0aGUgQVNUIG1ldGFkYXRhIG9iamVjdC5cbiAqL1xuZnVuY3Rpb24gdG9Ib3N0TWV0YWRhdGE8VEV4cHJlc3Npb24+KG1ldGFPYmo6IEFzdE9iamVjdDxSM0RlY2xhcmVEaXJlY3RpdmVNZXRhZGF0YSwgVEV4cHJlc3Npb24+KTpcbiAgICBSM0hvc3RNZXRhZGF0YSB7XG4gIGlmICghbWV0YU9iai5oYXMoJ2hvc3QnKSkge1xuICAgIHJldHVybiB7XG4gICAgICBhdHRyaWJ1dGVzOiB7fSxcbiAgICAgIGxpc3RlbmVyczoge30sXG4gICAgICBwcm9wZXJ0aWVzOiB7fSxcbiAgICAgIHNwZWNpYWxBdHRyaWJ1dGVzOiB7fSxcbiAgICB9O1xuICB9XG5cbiAgY29uc3QgaG9zdCA9IG1ldGFPYmouZ2V0T2JqZWN0KCdob3N0Jyk7XG5cbiAgY29uc3Qgc3BlY2lhbEF0dHJpYnV0ZXM6IFIzSG9zdE1ldGFkYXRhWydzcGVjaWFsQXR0cmlidXRlcyddID0ge307XG4gIGlmIChob3N0Lmhhcygnc3R5bGVBdHRyaWJ1dGUnKSkge1xuICAgIHNwZWNpYWxBdHRyaWJ1dGVzLnN0eWxlQXR0ciA9IGhvc3QuZ2V0U3RyaW5nKCdzdHlsZUF0dHJpYnV0ZScpO1xuICB9XG4gIGlmIChob3N0LmhhcygnY2xhc3NBdHRyaWJ1dGUnKSkge1xuICAgIHNwZWNpYWxBdHRyaWJ1dGVzLmNsYXNzQXR0ciA9IGhvc3QuZ2V0U3RyaW5nKCdjbGFzc0F0dHJpYnV0ZScpO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBhdHRyaWJ1dGVzOiBob3N0LmhhcygnYXR0cmlidXRlcycpID9cbiAgICAgICAgaG9zdC5nZXRPYmplY3QoJ2F0dHJpYnV0ZXMnKS50b0xpdGVyYWwodmFsdWUgPT4gdmFsdWUuZ2V0T3BhcXVlKCkpIDpcbiAgICAgICAge30sXG4gICAgbGlzdGVuZXJzOiBob3N0LmhhcygnbGlzdGVuZXJzJykgP1xuICAgICAgICBob3N0LmdldE9iamVjdCgnbGlzdGVuZXJzJykudG9MaXRlcmFsKHZhbHVlID0+IHZhbHVlLmdldFN0cmluZygpKSA6XG4gICAgICAgIHt9LFxuICAgIHByb3BlcnRpZXM6IGhvc3QuaGFzKCdwcm9wZXJ0aWVzJykgP1xuICAgICAgICBob3N0LmdldE9iamVjdCgncHJvcGVydGllcycpLnRvTGl0ZXJhbCh2YWx1ZSA9PiB2YWx1ZS5nZXRTdHJpbmcoKSkgOlxuICAgICAgICB7fSxcbiAgICBzcGVjaWFsQXR0cmlidXRlcyxcbiAgfTtcbn1cblxuLyoqXG4gKiBFeHRyYWN0cyB0aGUgbWV0YWRhdGEgZm9yIGEgc2luZ2xlIHF1ZXJ5IGZyb20gYW4gQVNUIG9iamVjdC5cbiAqL1xuZnVuY3Rpb24gdG9RdWVyeU1ldGFkYXRhPFRFeHByZXNzaW9uPihvYmo6IEFzdE9iamVjdDxSM0RlY2xhcmVRdWVyeU1ldGFkYXRhLCBURXhwcmVzc2lvbj4pOlxuICAgIFIzUXVlcnlNZXRhZGF0YSB7XG4gIGxldCBwcmVkaWNhdGU6IFIzUXVlcnlNZXRhZGF0YVsncHJlZGljYXRlJ107XG4gIGNvbnN0IHByZWRpY2F0ZUV4cHIgPSBvYmouZ2V0VmFsdWUoJ3ByZWRpY2F0ZScpO1xuICBpZiAocHJlZGljYXRlRXhwci5pc0FycmF5KCkpIHtcbiAgICBwcmVkaWNhdGUgPSBwcmVkaWNhdGVFeHByLmdldEFycmF5KCkubWFwKGVudHJ5ID0+IGVudHJ5LmdldFN0cmluZygpKTtcbiAgfSBlbHNlIHtcbiAgICBwcmVkaWNhdGUgPSBwcmVkaWNhdGVFeHByLmdldE9wYXF1ZSgpO1xuICB9XG4gIHJldHVybiB7XG4gICAgcHJvcGVydHlOYW1lOiBvYmouZ2V0U3RyaW5nKCdwcm9wZXJ0eU5hbWUnKSxcbiAgICBmaXJzdDogb2JqLmhhcygnZmlyc3QnKSA/IG9iai5nZXRCb29sZWFuKCdmaXJzdCcpIDogZmFsc2UsXG4gICAgcHJlZGljYXRlLFxuICAgIGRlc2NlbmRhbnRzOiBvYmouaGFzKCdkZXNjZW5kYW50cycpID8gb2JqLmdldEJvb2xlYW4oJ2Rlc2NlbmRhbnRzJykgOiBmYWxzZSxcbiAgICBlbWl0RGlzdGluY3RDaGFuZ2VzT25seTpcbiAgICAgICAgb2JqLmhhcygnZW1pdERpc3RpbmN0Q2hhbmdlc09ubHknKSA/IG9iai5nZXRCb29sZWFuKCdlbWl0RGlzdGluY3RDaGFuZ2VzT25seScpIDogdHJ1ZSxcbiAgICByZWFkOiBvYmouaGFzKCdyZWFkJykgPyBvYmouZ2V0T3BhcXVlKCdyZWFkJykgOiBudWxsLFxuICAgIHN0YXRpYzogb2JqLmhhcygnc3RhdGljJykgPyBvYmouZ2V0Qm9vbGVhbignc3RhdGljJykgOiBmYWxzZSxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVNvdXJjZVNwYW4ocmFuZ2U6IFJhbmdlLCBjb2RlOiBzdHJpbmcsIHNvdXJjZVVybDogc3RyaW5nKTogUGFyc2VTb3VyY2VTcGFuIHtcbiAgY29uc3Qgc291cmNlRmlsZSA9IG5ldyBQYXJzZVNvdXJjZUZpbGUoY29kZSwgc291cmNlVXJsKTtcbiAgY29uc3Qgc3RhcnRMb2NhdGlvbiA9XG4gICAgICBuZXcgUGFyc2VMb2NhdGlvbihzb3VyY2VGaWxlLCByYW5nZS5zdGFydFBvcywgcmFuZ2Uuc3RhcnRMaW5lLCByYW5nZS5zdGFydENvbCk7XG4gIHJldHVybiBuZXcgUGFyc2VTb3VyY2VTcGFuKHN0YXJ0TG9jYXRpb24sIHN0YXJ0TG9jYXRpb24ubW92ZUJ5KHJhbmdlLmVuZFBvcyAtIHJhbmdlLnN0YXJ0UG9zKSk7XG59XG4iXX0=